<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>000 An Introduction to LLVM | Yongjin Han</title> <meta name="author" content="Yongjin Han"/> <meta name="description" content="LLVM"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://dalnaracrater.github.io/blog/2024/000-Begining_LLVM/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Yongjin&nbsp;</span>Han</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="toggle-container"> <button id="light-toggle" title="dark mode is classy!. Yongjin"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">000 An Introduction to LLVM</h1> <p class="post-meta">April 24, 2024</p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> &nbsp; &middot; &nbsp; <a href="/blog/tag/llvm"> <i class="fa-solid fa-hashtag fa-sm"></i> LLVM</a> &nbsp; </p> </header> <article class="post-content"> <div id="markdown-content"> <p><em>In this tutorials, I will not go through all of theoritical concepts in comiler construction and optimization since the purpose of this article is to provide an introcution to LLVM and implement program analysis from scratch.</em> <em>한국어 번역은 <a href="">여기</a>에서 보실 수 있습니다.</em></p> <h1 id="llvm">LLVM</h1> <ul> <li>SSA With LLVM, you can create your own language, optimize a code before translating it into machine code. LLVM IR (Intermediate Representation) is an representation in the middle of source code and machine so that it can be used for optimization.</li> </ul> <h2 id="compilation-process">Compilation process</h2> <p>다음은 컴파일 과정을 도식화한 그림이다. LLVM은 AST 로 생성된 IR을 통해 최적화를 수행한다.</p> <ul> <li>Lexical analysis</li> <li>semantic analysis</li> <li>optimization</li> </ul> <h2 id="installation">Installation</h2> <ul> <li>download: github</li> <li>build: 간단한 빌드</li> </ul> <h2 id="writing-an-llvm-pass">Writing an LLVM Pass</h2> <ol> <li>Create a Pass folder at <code class="language-plaintext highlighter-rouge">./lib/Transformation</code></li> </ol> <ul> <li>print hello world</li> </ul> <details open=""> <summary>Code</summary> <br/> ```cpp #include "llvm/Pass.h" #include "llvm/IR/Function.h" #include "llvm/Support/raw_ostream.h" using namespace llvm; namespace { struct HelloLLVM : public FunctionPass { static char ID; HelloLLVM() : FunctionPass(ID) {} bool runOnFunction(Function &amp;F) override { errs() &lt;&lt; "Hello LLVM!"; return false; } }; // end of struct } // end of anonymous namespace char HelloLLVM::ID = 0; static RegisterPass<HelloLLVM> X("PrintHello", "Print Hello LLVM!", false /* Only looks at CFG */, false /* Analysis Pass */); ``` &lt;/details&gt; We just printed 'Hello LLVM!' on your Terminal! But we don't know how it works yet. - header ```cpp #include "llvm/Pass.h" #include "llvm/IR/Function.h" #include "llvm/Support/raw_ostream.h" ``` We will write an LLVM Pass and this pass run over functions in a program. To print 'Hello LLVM!' out, we need to specify which stream we use. In this case, the output stream is `errs()` In llvm, a pass has an unique ID so we define `char ID` as static. After defining struct for a pass, we need to register the pass: `static RigisterPass<YourPass> VarName("OptionName", "Description", "false", "false")`. This way of registering a pass is called a *legacy pass*. Nowadays, New Pass Manager is used more often. ## LLVM structure - Module - Function - BasicBlock - Instruction HelloLLVM 패스는 각 함수마다 최적화("Hello LLVM!" 출력하기)를 수행한다. 이렇듯 최적화 패스를 작성하기 위해서는 LLVM IR의 구조를 알아야 하는데 위 그림에서와 같이 크게 `Module`, `Function`, `BasicBlock`, `Instruction`으로 나눌 수 있다. `Instruction`이 모여 `BasicBlock`을 구성하고, `BasicBlock`이 모여 `Function`을 구성한다. 마지막으로 `Function`이 모여 `Module`을 구성한다. 각 구조는 `loop statement`를 통해 탐색할 수 있으며 이는 다음에 알아보도록 하자. ## Pass Manager ### Legacy pass manager ```cpp char llvmPass000::ID = 0; static RegisterPass<llvmPass000> X("command", "description", false, false); ``` ### New pass manager ```cpp ``` ## Analysis vs Transformation **Program analysis** invests program whether they have undefined behavior such as misuse of pointer, unused variables, memeory reference, etc. This does not change a target source code but look at it and alarm to users. On the other hand, **program transformation** not only search the source code but also optimize it by removing unnecessary code snipet or converting it into more efficient code. A table shown below links to other pages for supplimental analysis and transformation. You can follow the links to dive into LLVM pass. |Pass|Type| |---|---| |[Writing HelloLLVM Pass](../000-Begining_LLVM)|analysis| |[Iterating over Module, Function, Basic block](../Iterating_over_Module_Function_BasicBlock)|analysis| |[Count the number of insts, func calls](../002-Count_insts_calls)| analysis| |[Insert func call](../003-Insert_func_call)|transformation| |[Change Insts (obfuscation)](../004-Change_Insts_(obfuscation))|transformation| |[Control flow graph](../005-Traverse_CFG)|transformation| ### Did you enjoy the LLVM tutorial? Now it's time to study **program analysis**. [here!](./2024-03-14-101-Program_analysis_with_LLVM%20copy.md) ## Reference [1] Andrzej Warzyński. llvm-tutor. [github](https://github.com/banach-space/llvm-tutor)\ [2] Adrian Sampson. LLVM for Grad Students. [blog](https://www.cs.cornell.edu/~asampson/blog/llvm.html)\ [3] Keshav Pingali. CS 380C: Advanced Topics in Compilers. [blog](https://www.cs.utexas.edu/~pingali/CS380C/2020/assignments/assignment4/index.html)\ [4] Arthur Eubanks. The New Pass Manager. [blog](https://blog.llvm.org/posts/2021-03-26-the-new-pass-manager) </llvmPass000></YourPass></HelloLLVM></details> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/000-Begining_LLVM(KOR)/">000 An Introduction to LLVM(KOR)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/002-Count_insts_calls/">002 Count the number of instructions and function calls</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/001-Iterating_over_Module_Function_BasicBlock/">001 Iterating Module, Function, and Basicblock with LLVM</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/004-Change_Insts_(obfuscation)/">004 Change Instructions (obfuscation)</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/005-Traverse_CFG/">005 Traverse Control flow graph</a> </li> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> &copy; Copyright 2024 Yongjin Han. Happy New Year! </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?07b8786bab9b4abe90d10e61f7d12ff7" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-M6YE7F4X7F"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-M6YE7F4X7F");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>